# The default action to take if no policies match.
default_action: production

# Defines the evaluation order. The engine processes these sections top-to-bottom.
evaluation_order:
  - directives
  - trusted_workflows
  - security_policies
  - accumulated_risk_policies
  - risk_based_policies

# 1. Directives: Absolute Manual Overrides
# For emergency lockdown or administrative actions. Bypasses all other logic.
directives:
  users: {} # Example: "admin": { "action": "production", "reason": "Admin override" }
  roles: {} # Example: "auditor": { "action": "shadow", "reason": "Auditors are sandboxed" }

# 2. Trusted Workflows: Guarantees for Benign Users
# These rules are deterministic and run BEFORE security checks to prevent false positives.
trusted_workflows:
  - id: dr-chen-production
    description: "Trusted lead researcher workflow."
    match:
      all:
        - { field: "context.user_id", operator: "eq", value: "dr_chen" }
        - {
            field: "context.user_role",
            operator: "eq",
            value: "lead_researcher",
          }
    action: production

# 3. Security Policies: Deterministic Threat Detection
# A list of rules that identify known-bad patterns. They run after trusted workflows.
# IMPORTANT: Use "deny" for permission violations, "shadow" for adversarial attacks
security_policies:
  - id: taint-permission-block
    description: "Tainted sessions cannot access sensitive tools - PERMISSION DENIAL"
    match:
      all:
        - { field: "context.is_tainted", operator: "eq", value: true }
        - { field: "tool_category", operator: "eq", value: "sensitive" }
    action: deny
    reason: "Access denied: Session tainted by untrusted data source"

  - id: suspicious-keyword-attack-detection
    description: "Routes to shadow if suspicious keyword detected - ATTACK HONEYPOT"
    match:
      all:
        - { field: "context.is_suspicious_query", operator: "eq", value: true }
    action: shadow
    reason: "Potential data exfiltration attempt detected"

  - id: external-user-attack-honeypot
    description: "All actions from external users routed to shadow for monitoring - ATTACK HONEYPOT"
    tools: ["*"]
    match:
      all:
        - field: "context.user_role"
          operator: "eq"
          value: "external"
    action: shadow
    reason: "External user activity - routed to honeypot for monitoring"

  - id: cross-tenant-attack-detection
    description: "Route cross-tenant medical record access to shadow - ATTACK HONEYPOT"
    tools: ["get_patient_record"]
    match:
      all:
        - {
            field: "args.patient_id",
            operator: "neq",
            value_from_context: "user_id",
          }
    action: shadow
    reason: "Cross-tenant access attempt detected"

# 4. Accumulated Risk Policy
# Triggers if the session's cumulative risk score exceeds a threshold.
accumulated_risk_policies:
  threshold: 1.5
  action: shadow
  reason: "Cumulative risk across session exceeds threshold of 1.5"

# 5. Risk-Based Policies (Single Event)
# The final check based on the LLM's real-time risk assessment of the current tool call.
risk_based_policies:
  risk_threshold: 0.8
  min_confidence: 0.7
  action: shadow # Action if both thresholds are met.
  low_confidence_action: production # Fail-safe action if risk is high but confidence is low.
